<div class="card mt-2 mb-2 the-shadow text-center" style="overflow-x: auto;">
  <div class="card-header fw-bold text-center">
    League Advanced Stats (Full Table)
  </div>

  <div class="card-body" style="overflow-x: auto;">
    <table id="league-advanced-stats-table"
          class="table table-sm table-bordered table-hover text-center nowrap"
          style="width: 100%;">

      <thead class="table-light">
        <tr>

          <th class="sticky-col">Team</th>

          <th>Age</th>

          <th data-bs-toggle="tooltip" title="Wins">
            W
          </th>

          <th data-bs-toggle="tooltip" title="Losses">
            L
          </th>

          <th data-bs-toggle="tooltip" title="Pythagorean Wins (expected wins based on points scored and allowed)">
            PW
          </th>

          <th data-bs-toggle="tooltip" title="Pythagorean Losses (expected losses based on points scored and allowed)">
            PL
          </th>

          <th data-bs-toggle="tooltip" title="Margin of Victory">
            MOV
          </th>

          <th data-bs-toggle="tooltip" title="Strength of Schedule (0 is average)">
            SOS
          </th>

          <th data-bs-toggle="tooltip" title="Simple Rating System (0 is average)">
            SRS
          </th>

          <th data-bs-toggle="tooltip" title="Offensive Rating (Estimated points scored per 100 possessions)">
            ORtg
          </th>

          <th data-bs-toggle="tooltip" title="Defensive Rating (Estimated points allowed per 100 possessions)">
            DRtg
          </th>

          <th data-bs-toggle="tooltip" title="Net Rating (Point differential per 100 possessions)">
            NRtg
          </th>

          <th data-bs-toggle="tooltip" title="Estimated possessions per 48 minutes">
            Pace
          </th>

          <th data-bs-toggle="tooltip" title="Free Throw Attempt Rate (Number of free throw attempts per field goal attempt)">
            FTr
          </th>

          <th data-bs-toggle="tooltip" title="Three-Point Attempt Rate (Percentage of field goal attempts taken from 3-point range)">
            3PAr
          </th>

          <th data-bs-toggle="tooltip" title="True Shooting Percentage (Efficiency considering 2P, 3P, and FT shooting)">
            TS%
          </th>

          <th data-bs-toggle="tooltip" title="Effective Field Goal Percentage (Adjusts because 3-pointers are worth more)">
            eFG%
          </th>

          <th data-bs-toggle="tooltip" title="Turnover Percentage (Turnovers per 100 possessions)">
            TOV%
          </th>

          <th data-bs-toggle="tooltip" title="Offensive Rebound Percentage (Estimate of the percentage of available offensive rebounds a team grabs)">
            ORB%
          </th>

          <th data-bs-toggle="tooltip" title="Free throw attempts per field goal attempt">
            FT/FGA
          </th>

          <th data-bs-toggle="tooltip" title="Opponent Effective Field Goal Percentage">
            Opp eFG%
          </th>

          <th data-bs-toggle="tooltip" title="Opponent Turnover Percentage">
            Opp TOV%
          </th>

          <th data-bs-toggle="tooltip" title="Opponent Defensive Rebound Percentage">
            Opp DRB%
          </th>

          <th data-bs-toggle="tooltip" title="Opponent free throw attempts per field goal attempt">
            Opp FT/FGA
          </th>

        </tr>
      </thead>

      <tbody>
        <% @adv_stats.each do |adv| %>
          <% s = adv.stats %>
          <% r = adv.rankings || {} %>

      <tr>

        <!-- TEAM: logo + name -->
        <td class="fw-bold sticky-col text-start">
          <img 
            src="https://cdn.ssref.net/req/202410231/tlogo/bbr/<%= adv.team.abbreviation %>-<%= @current_season.end_year %>.png"
            alt="<%= adv.team.name %> logo"
            width="28"
            height="28"
            class="me-2"
          >
          <%= adv.team.name %>
        </td>

        <!-- AGE -->
        <td data-order="<%= s['age'].to_f %>"><%= s["age"] %></td>

        <!-- WINS / LOSSES / PYTHAG -->
        <td data-order="<%= s['wins'].to_f %>"><%= s["wins"] %></td>
        <td data-order="<%= s['losses'].to_f %>"><%= s["losses"] %></td>
        <td data-order="<%= s['wins_pyth'].to_f %>"><%= s["wins_pyth"] %></td>
        <td data-order="<%= s['losses_pyth'].to_f %>"><%= s["losses_pyth"] %></td>

        <!-- MOV / SOS / SRS -->
        <td data-order="<%= s['mov'].to_f %>">
          <%= s["mov"] %> <small class="text-muted">( <%= r["mov_rank"] %> )</small>
        </td>

        <td data-order="<%= s['sos'].to_f %>">
          <%= s["sos"] %> <small class="text-muted">( <%= r["sos_rank"] %> )</small>
        </td>

        <td data-order="<%= s['srs'].to_f %>">
          <%= s["srs"] %> <small class="text-muted">( <%= r["srs_rank"] %> )</small>
        </td>

        <!-- OFF/DEF/NET RATINGS -->
        <td data-order="<%= s['off_rtg'].to_f %>">
          <%= s["off_rtg"] %> <small>( <%= r["off_rtg_rank"] %> )</small>
        </td>

        <td data-order="<%= s['def_rtg'].to_f %>">
          <%= s["def_rtg"] %> <small>( <%= r["def_rtg_rank"] %> )</small>
        </td>

        <td data-order="<%= s['net_rtg'].to_f %>">
          <%= s["net_rtg"] %> <small>( <%= r["net_rtg_rank"] %> )</small>
        </td>

        <!-- PACE -->
        <td data-order="<%= s['pace'].to_f %>">
          <%= s["pace"] %> <small>( <%= r["pace_rank"] %> )</small>
        </td>

        <!-- FT/FGA -->
        <td data-order="<%= s['fta_per_fga_pct'].to_f %>">
          <%= s["fta_per_fga_pct"] %>
          <small class="text-muted">( <%= r["fta_per_fga_pct_rank"] %> )</small>
        </td>

        <!-- 3PAr -->
        <td data-order="<%= s['fg3a_per_fga_pct'].to_f %>">
          <%= s["fg3a_per_fga_pct"] %>
          <small class="text-muted">( <%= r["fg3a_per_fga_pct_rank"] %> )</small>
        </td>

        <!-- TS% -->
        <td data-order="<%= s['ts_pct'].to_f %>">
          <%= s["ts_pct"] %>
          <small class="text-muted">( <%= r["ts_pct_rank"] %> )</small>
        </td>

        <!-- eFG% -->
        <td data-order="<%= s['efg_pct'].to_f %>">
          <%= s["efg_pct"] %>
          <small class="text-muted">( <%= r["efg_pct_rank"] %> )</small>
        </td>

        <!-- TOV% -->
        <td data-order="<%= s['tov_pct'].to_f %>">
          <%= s["tov_pct"] %>
          <small class="text-muted">( <%= r["tov_pct_rank"] %> )</small>
        </td>

        <!-- ORB% -->
        <td data-order="<%= s['orb_pct'].to_f %>">
          <%= s["orb_pct"] %>
          <small class="text-muted">( <%= r["orb_pct_rank"] %> )</small>
        </td>

        <!-- FT Rate -->
        <td data-order="<%= s['ft_rate'].to_f %>">
          <%= s["ft_rate"] %>
          <small class="text-muted">( <%= r["ft_rate_rank"] %> )</small>
        </td>

        <!-- OPP eFG% -->
        <td data-order="<%= s['opp_efg_pct'].to_f %>">
          <%= s["opp_efg_pct"] %>
          <small class="text-muted">( <%= r["opp_efg_pct_rank"] %> )</small>
        </td>

        <!-- OPP TOV% -->
        <td data-order="<%= s['opp_tov_pct'].to_f %>">
          <%= s["opp_tov_pct"] %>
          <small class="text-muted">( <%= r["opp_tov_pct_rank"] %> )</small>
        </td>

        <!-- DRB% -->
        <td data-order="<%= s['drb_pct'].to_f %>">
          <%= s["drb_pct"] %>
          <small class="text-muted">( <%= r["drb_pct_rank"] %> )</small>
        </td>

        <!-- Opp FT Rate -->
        <td data-order="<%= s['opp_ft_rate'].to_f %>">
          <%= s["opp_ft_rate"] %>
          <small class="text-muted">( <%= r["opp_ft_rate_rank"] %> )</small>
        </td>

      </tr>

        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
(function () {
  const tableId = "#league-advanced-stats-table";
  const frameId = "standings_frame";

  // Which columns to color + how to rank them
  // idx = zero-based column index in the table
  // dir = "desc" means higher value = better (green)
  // dir = "asc"  means lower value = better (green)
  const columnsToColor = [
    { idx: 6, dir: "desc" },
    { idx: 7, dir: "desc" },
    { idx: 8, dir: "desc" },
    { idx: 9, dir: "desc" },
    { idx: 10, dir: "asc" },
    { idx: 11, dir: "desc" },
    { idx: 12, dir: "desc" },
    { idx: 13, dir: "desc" },
    { idx: 14, dir: "desc" },
    { idx: 15, dir: "desc" },
    { idx: 16, dir: "desc" },
    { idx: 17, dir: "asc" },
    { idx: 18, dir: "desc" },
    { idx: 19, dir: "desc" },
    { idx: 20, dir: "asc" },
    { idx: 21, dir: "desc" },
    { idx: 22, dir: "desc" },
    { idx: 23, dir: "asc" }            
  ];

  function initLeagueAdvancedStatsTable() {
    const tableElement = document.querySelector(tableId);
    if (!tableElement) return;

    // Destroy if exists
    if ($.fn.DataTable.isDataTable(tableId)) {
      $(tableId).DataTable().destroy();
    }

    const table = $(tableId).DataTable({
      order: [[8, "desc"]],
      pageLength: 30,
      lengthChange: true,
      searching: true,
      paging: true,
      autoWidth: false,
      columnDefs: [{ className: "no-expansion", targets: "_all" }]
    });

    // Initial apply
    applyStickyColumn(tableId, "white");
    applyBootstrapColorCoding(tableId, columnsToColor);

    // Reapply after each draw
    table.on("draw", function () {
      applyStickyColumn(tableId, "white");
      applyBootstrapColorCoding(tableId, columnsToColor);
    });
  }

  function applyStickyColumn(tableId, backgroundColor) {
    $(`${tableId} .sticky-col`).each(function () {
      $(this).css({
        position: "sticky",
        left: "0",
        backgroundColor: backgroundColor,
        zIndex: "2",
        borderRight: "1px solid #ddd"
      });
    });
  }

  // Same gradient idea you already use, but:
  // - works per-column with asc/desc direction
  // - parses values robustly (%, commas, +/-, etc.)
  function applyBootstrapColorCoding(tableId, columnsConfig) {
    const dt = $(tableId).DataTable();

    // Use filtered rows across all pages for ranking consistency
    const rows = dt.rows({ search: "applied" }).nodes();

    columnsConfig.forEach(({ idx: columnIndex, dir }) => {
      const values = Array.from(rows).map((row) => {
        const cell = row.cells[columnIndex];
        if (!cell) return null;

        const text = cell.textContent.trim();
        const num = parseCellNumber(text);
        return isNaN(num) ? null : num;
      });

      let rankedRows = values
        .map((value, index) => ({ value, index }))
        .filter((entry) => entry.value !== null);

      // Sort for ranking
      rankedRows.sort((a, b) => {
        return dir === "asc" ? (a.value - b.value) : (b.value - a.value);
      });

      rankedRows = rankedRows.map((entry, rank) => ({ ...entry, rank: rank + 1 }));

      if (rankedRows.length === 0) return;

      const maxRank = Math.max(...rankedRows.map((entry) => entry.rank));
      const midRank = Math.ceil(maxRank / 2);

      rankedRows.forEach(({ index, rank }) => {
        const cell = rows[index].cells[columnIndex];
        if (!cell) return;

        let backgroundColor;

        // Top half -> green -> white
        if (rank <= midRank) {
          const ratio = midRank === 1 ? 0 : (rank - 1) / (midRank - 1);
          const red = Math.round(76 + (255 - 76) * ratio);
          const green = Math.round(175 + (255 - 175) * ratio);
          const blue = Math.round(80 + (255 - 80) * ratio);
          backgroundColor = `rgb(${red}, ${green}, ${blue})`;
        } else {
          // Bottom half -> white -> red
          const ratio = maxRank === midRank ? 0 : (rank - midRank) / (maxRank - midRank);
          const red = Math.round(255 + (162 - 255) * ratio);
          const green = Math.round(255 + (0 - 255) * ratio);
          const blue = Math.round(255 + (0 - 255) * ratio);
          backgroundColor = `rgb(${red}, ${green}, ${blue})`;
        }

        cell.style.backgroundColor = backgroundColor;
        cell.style.color = "black";
      });
    });
  }

  function parseCellNumber(text) {
    if (!text || text === "-") return NaN;

    // Remove commas and % signs
    const cleaned = text.replace(/,/g, "").replace(/%/g, "").trim();

    // Pull first number from the string (handles +4.2, 10.5, etc.)
    const match = cleaned.match(/[+-]?\d+(\.\d+)?/);
    return match ? parseFloat(match[0]) : NaN;
  }

  // Run on full page load
  document.addEventListener("turbo:load", initLeagueAdvancedStatsTable);

  // Run again when standings_frame renders
  document.addEventListener("turbo:frame-load", function (event) {
    if (event.target.id === frameId) {
      initLeagueAdvancedStatsTable();
    }
  });

  // Cleanup before Turbo caches
  document.addEventListener("turbo:before-cache", function () {
    if ($.fn.DataTable.isDataTable(tableId)) {
      $(tableId).DataTable().destroy();
    }
  });
})();
</script>
