<% rows = build_depth_rows_for(team.id) %>

<%
  roster_all = (@all_players_by_team[team.id] || [])

  status_for = ->(player) do
    s = player&.health&.status.to_s.strip
    s.present? ? s : "Healthy"
  end

  out_players = roster_all.select { |p| status_for.call(p) == "Out" }

%>

<div class="card h-100">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center">
      <img src="https://cdn.ssref.net/req/202410231/tlogo/bbr/<%= team.abbreviation %>-2025.png"
           alt="<%= team.name %> logo"
           width="26" height="26"
           class="me-2">
      <div class="fw-bold"><%= team.name %></div>
    </div>

  </div>

  <div class="card-body">
    <% total_minutes = rows.sum { |r| r[:expected_minutes].to_f } %>

    <table class="table table-sm mb-0">
      <thead class="table-light">
        <tr>
          <th>Player</th>
          <th style="width: 55px;">Pos</th>
          <th class="text-end" style="width: 90px;">Min</th>
        </tr>
      </thead>

      <tbody>
        <% rows.each do |r| %>
          <% player = r[:player] %>
          <% p_status = player ? status_for.call(player) : nil %>

          <tr>
            <td>
              <% if player %>
                <div class="d-flex align-items-center justify-content-between">
                  <%= link_to team_player_path(player.team, player),
                              data: (
                                player.health&.description.present? ?
                                {
                                  turbo: false,
                                  bs_toggle: "tooltip",
                                  bs_placement: "right",
                                  bs_title: player.health.description
                                } :
                                { turbo: false }
                              ),
                              class: "d-inline-flex align-items-center text-decoration-none" do %>

                    <img src="<%= player.profile_picture_url %>"
                        width="20"
                        height="auto"
                        class="me-2 rounded-circle">

                    <span>
                      <%= "#{player.name.split.first[0]}. #{player.name.split.drop(1).join(' ')}" %>
                    </span>
                  <% end %>

                  <% if p_status.present? && p_status != "Healthy" %>
                    <span class="badge bg-warning text-dark ms-2"><%= p_status %></span>
                  <% end %>
                </div>
              <% else %>
                <span class="text-muted">—</span>
              <% end %>
            </td>

            <td><%= r[:pos] || "—" %></td>

            <td class="text-end">
              <%= r[:expected_minutes].to_f.round(1) %>
            </td>
          </tr>
        <% end %>
      </tbody>


      <tfoot>
        <tr class="table-light">
          <th colspan="2" class="text-end">Total</th>
          <th class="text-end">
            <strong><%= total_minutes.round(1) %></strong>
          </th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card-footer bg-white">
    <div class="small fw-bold text-muted mb-1">Out</div>

    <% if out_players.any? %>
      <div class="d-flex flex-wrap gap-2">
        <% out_players.sort_by { |p| p.name.to_s }.each do |p| %>
          <span class="badge bg-light text-dark border">
            <%= p.name %>: <span class="fw-bold">Out</span>
          </span>
        <% end %>
      </div>
    <% else %>
      <div class="small text-muted">No players listed as Out.</div>
    <% end %>
  </div>

</div>
